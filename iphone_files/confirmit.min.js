$.extend({ confirmIt: function (e) { var i = { domain: document.location.protocol + "//" + document.location.host, pathName: location.pathname.toLowerCase() }, o = $.extend({}, i, env.survey, e), t = { isInSampling: function () { var e = Math.floor(100 * Math.random()) + 1; return e <= o.samplingPercentage ? !0 : !1 }, isNotExcluded: { fromPageViewCount: function () { var e, i = o.excludes; for (var t in i) o.pathName.indexOf(i[t]) > -1 && (e = !0); return e ? !1 : !0 }, fromDisplayingSurvey: function () { var e; return ("/" === o.pathName || o.pathName.indexOf("home.aspx") > -1) && (e = !0), e ? !1 : !0 } }, pageVisits: { getTotal: function () { return $.cookie(o.cookies.pageVisits) }, increment: function () { var e = $.cookie(o.cookies.pageVisits); return e = e ? (parseInt(e, 10) + 1).toString() : "1", $.cookie(o.cookies.pageVisits, e, { path: "/", domain: env.cookieDomain }), this.getTotal() ? !1 : !0 }, destroy: function () { return $.cookie(o.cookies.pageVisits, null, { path: "/", domain: env.cookieDomain }), this.getTotal() ? !1 : !0 } }, optOut: { exist: function () { return $.cookie(o.cookies.optOut) ? !0 : !1 }, create: function () { return $.cookie(o.cookies.optOut, "true", { expires: o.optOut, path: "/", domain: env.cookieDomain }), this.exist() } }, referrer: function () { var e = { domain: document.referrer.split("/")[2], url: document.referrer }; return "www.bestbuy.ca" === e.domain ? !1 : e }, userInfo: function () { var e = { locale: env.lang, "exit-page": window.location.href, "survey-time": (new Date).getTime(), "screen-width": window.outerWidth || $(window).outerWidth(), "screen-height": window.outerHeight || $(window).outerHeight(), "window-width": window.innerWidth || $(window).innerWidth(), "window-height": window.innerHeight || $(window).innerHeight() }; $.cookie(o.cookies.tracker) && (e["page-view"] = "undefined" != typeof $.cookie(o.cookies.tracker).pageView ? $.cookie(o.cookies.tracker).pageView : "0", e.referrer = $.cookie(o.cookies.tracker).referrer ? $.cookie(o.cookies.tracker).referrer : ""); var i = []; for (var t in e) i.push(encodeURIComponent(t) + "=" + encodeURIComponent(e[t])); return i.join("&") }, inviteToSurvey: function () { var e = this; e.pageVisits.destroy(), e.optOut.create(), $(document).modal({ show: ".survey-invite." + env.lang }, function () { $(document).on("click", ".survey-yes", function (i) { i.preventDefault(), e.displaySurveyPopup() }) }); var i = { htmlPath: o.domain + o.pages.invite }; $(document).trigger("showModal", i) }, displaySurveyPopup: function () { var e = o.domain + o.pages.survey + "?cookie=" + o.cookies.tracker + "&lang=" + env.lang + "&w=" + o.pages.confirmItWidth + "&h=" + o.pages.confirmItHeight + "&ie=" + env.isIE + "&tabCookie=" + o.cookies.tabs + "&cookieDomain=" + env.cookieDomain, i = o.pages.width, t = o.pages.height, n = screen.width / 2 - i / 2, r = screen.height / 2 - t / 2; window.open(e, "BestBuy", "toolbar=no, location=no, directories=no, status=no, menubar=no,scrollbars=yes, resizable=yes, copyhistory=no,width=" + i + ", height=" + t + ", top=" + r + ", left=" + n) }, tracker: function () { var e = this; $(document).on("ready", function () { var i = {}, t = $.cookie(o.cookies.tracker); i.pageView = t ? (parseInt(t.pageView, 10) + 1).toString() : "1", e.referrer() && (i.referrer = e.referrer().domain, i.referrerUrl = e.referrer().url), i.surveyPath = o.pages[env.lang] + "&" + e.userInfo(), $.cookie(o.cookies.tracker, i, { path: "/", domain: env.cookieDomain }) }); var i = window.onpagehide || null === window.onpagehide ? "pagehide" : "unload"; $(window).on(i, function () { var i = {}; i = $.cookie(o.cookies.tracker), i.surveyPath = o.pages[env.lang] + "&" + e.userInfo(), $.cookie(o.cookies.tracker, i, { path: "/", domain: env.cookieDomain }) }) }, isFirstVisit: function () { return this.pageVisits.getTotal() ? !1 : !0 }, isQualified: function () { return o.enabled === !0 && this.isNotExcluded.fromPageViewCount() && !this.optOut.exist() && this.isInSampling() }, isReachedThreshold: function () { return this.pageVisits.getTotal() >= o.pageViewThreshhold }, generateGUID: function () { var e = function () { return Math.floor(65536 * Math.random()).toString(16) }; return e() + e() + "-" + e() + "-" + e() + "-" + e() + "-" + e() + e() + e() }, windowName: { set: function (e) { return window.name.match(/^GUID-/) || (window.name = "GUID-" + e), window.name }, get: function () { return window.name } }, tabHeartbeat: function () { window.name || this.windowName.set(this.generateGUID()); var e = JSON.parse($.cookie(o.cookies.tabs)); -1 === jQuery.inArray(window.name, e) && (e || (e = []), e.push(this.windowName.get()), $.cookie(o.cookies.tabs, JSON.stringify(e), { path: "/", domain: env.cookieDomain })) }, registerCurrentTab: function () { $.cookie(o.cookies.tabs) || $.cookie(o.cookies.tabs, JSON.stringify([]), { path: "/", domain: env.cookieDomain }); { var e = this; window.setInterval(function () { e.tabHeartbeat() }, 2e3) } }, init: function () { this.windowName.set(this.generateGUID()), this.registerCurrentTab(), this.tracker(), this.isFirstVisit() ? this.isQualified() && this.pageVisits.increment() : this.isNotExcluded.fromPageViewCount() && (this.pageVisits.increment(), this.isReachedThreshold() && this.isNotExcluded.fromDisplayingSurvey() && this.inviteToSurvey()) } }; return t } });